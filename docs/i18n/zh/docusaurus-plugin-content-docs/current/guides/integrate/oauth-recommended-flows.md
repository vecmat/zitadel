---
title: 推荐授权流程
---

<table class="table-wrapper">
    <tr>
        <td>描述</td>
        <td>了解不同的身份验证流以及我们建议您对您的应用程序使用哪个流程。</td>
    </tr>
    <tr>
        <td>学习成果</td>
        <td>
            在此模块中，您将：
            <ul>
              <li>学习联邦身份的基础</li>
              <li>了解OAuth 2.x 客户端配置及其对授权流的重要性</li>
              <li>为Web、Nite、User-Agent和 API 获取推荐流程</li>
            </ul>
        </td>
    </tr>
     <tr>
        <td>必备条件</td>
        <td>
            关于联邦身份的基本知识
        </td>
    </tr>
</table>

## 导言

在我们开始在ZITADEL内提出第一份申请之前， 我们需要通过一些关于如何通过 OpenID Connect 1 获得授权的基础知识。 和 OAuth 2.x

ZITADEL没有对您将要整合的应用程序类型作出假设。 因此，您必须具备资格并定义一个适当的方法，让您的用户获得访问您的应用程序的授权(“认证流程”)。 您的选择取决于应用程序是否能够保持客户端证书的保密性和应用程序的技术能力。 如果您选择了一个废弃或不可行的流程来获取您的应用程序的授权，您的用户的凭据可能会受到损害。

我们邀请您在OAuth 2.x 标准中进一步探索不同的授权流程。 从一开始，我们就假定你有一个全新的应用程序(ie. 没有遗留的要求。你找到了一个可靠的 SDK/LibLibrary，为你带来了沉重的提升。

因此，该模块将只会超越基础知识并解释为什么我们建议“使用PKCE的授权流”作为大多数应用程序的默认值。 我们还将述及机器间沟通的情况，即没有互动登录的情况。 此外，如果缺省流不可行，我们将引导您进一步阅读可行的替代方法。

## 联合身份基础知识

虽然联邦身份不是一个新的概念([RFC 6749](https://tools.ietf.org/html/rfc6749), “OAuth 2.0 授权框架”于2012年发布)，必须强调传统的客户端-服务器认证模式与授权和认证概念之间的区别。

上述RFC 为我们提供了一些客户端-服务器身份验证的 [个问题和限制](https://tools.ietf.org/html/rfc6749#section-1) 个， 客户端通过用户凭据身份验证请求服务器上受保护的资源：

* 应用程序需要存储用户证书（例如密码）以备将来使用；任何应用程序的妥协结果都会损害最终用户的全权证书
* 需要服务器来支持密码身份验证
* 在提供用户凭据时，如果没有限制范围，应用程序将获得过于广泛的受保护资源访问权限
* 用户不能撤销单个应用程序的访问权限，只能通过更改凭据来取消所有用户的访问。

那么，我们想要通过授权认证实现什么样的目标？

* 不要在每个服务器上进行身份验证并信任每个服务器
  * 用户只能使用 **使用信任服务器** 验证信任服务器 ie. ZITADEL，通过挑战验证用户身份(例如多个身份验证因素)，并发出 **ID令牌** (OpenID Connect 1.x)
  * 应用程序有手段 **验证显示的访问和ID令牌的完整性**

* 不要围绕用户的凭据发送
  * 客户端可以使用 **访问令牌** 访问保护资源，该令牌只适用于特定的范围和限定的生命周期(OAuth 2.x)
  * 用户必须 **授权** 应用程序访问确定 [**范围**](../../apis/openidoauth/scopes) (e.g, 电子邮件地址或自定义角色)。 应用程序可以请求 [**claims**](../../apis/openidoauth/claims) (key:value pairs, eg 电子邮件地址) 授权范围内的 ZITADEL的访问令牌或 ID 令牌
  * 访问令牌是无记名令牌，意味着对令牌的拥有提供了对资源的访问。 但令牌常常过期，应用程序必须通过 **刷新令牌** 或用户必须重新认证一个新的访问令牌。

![联邦身份概览](/img/guides/consulting_federated_identities_basics.png)

在这种情况下，出现了所谓的“流动”：在如何处理认证程序方面有一些不同的流动， 通过授权、 获取令牌和请求有关用户的额外信息。

也许有意思的是，我们主要关心的是选择正确的OAuth 2.x 流量(另称“授权”)。 OpenID Connect 扩展 OAuth 2。 具有有用功能的流程，如端点发现(如果要问的话)，ID令牌(这是用户) 用户信息端点(获取有关用户的更多信息)。

## 不同的客户信息

如本单元开头所述，选择最佳授权流程有两个主要决定因素：

1. 客户端对客户端证书保密的能力
2. 技术限制

OAuth 2.x 定义了两种 [客户端类型](https://tools.ietf.org/html/rfc6749#section-2.1) ，基于他们对客户端证书保密的能力：

* 保密：能够对其全权证书保密的客户(例如： 客户端在安全服务器上实施，对客户端证书的访问受限，或能够使用其他手段安全客户端认证。
* 公开：无力对其证书保密的客户(例如： 在资源所有者使用的设备上执行客户端，例如已安装的本地应用程序或基于网页浏览器的应用程序， 并且无法通过任何其他方式安全客户端认证。

下表简要概述了不同的客户端简介。

<table class="table-wrapper">
    <tr>
        <th>客户证书的保密</th>
        <th>客户端资料</th>
        <th>客户示例</th>
    </tr>
    <tr>
        <td rowspan="2">公开的</td>
        <td>用户代理</td>
        <td>单页网页应用程序(SPA)，通常在浏览器中执行 JavaScript</td>
    </tr>
    <tr>
        <td>原生的</td>
        <td>无，移动或桌面应用程序</td>
    </tr>
    <tr>
        <td rowspan="2">密文</td>
        <td>Web</td>
        <td>服务器端的网络应用程序，例如java、.net、 …</td>
    </tr>
    <tr>
        <td>机器到机</td>
        <td>API，通常是在授权服务器上没有直接用户交互的服务</td>
    </tr>
</table>

## 我们推荐的授权流程

我们建议使用流程 **"授权码带有验证码交换码(PCKE)"** [RFC7636](https://tools.ietf.org/html/rfc7636) **用户代理**, **本机**, 和 **Web** 客户。

如果您没有任何技术限制，您应该优先使用PKCE 的流程授权代码而不是其他方法。 PKCE部分根据RFC7636中所述的授权代码拦截攻击来防止流量。

*那么API是什么呢？*

我们建议对机器客户端使用 **“JWT 带私人钥匙的无记者令牌”** ([RFC7523](https://tools.ietf.org/html/rfc7523))。

这意味着您必须发送一个 JWT 令牌， 包含 [个标准的访问令牌](../../apis/openidoauth/claims) 的请求，并且这个请求是用您的私钥签名的， 到请求访问令牌的令牌端点。 我们将看到这如何在另一个关于服务帐户的模块中工作。

如果您没有任何技术限制，您应该优先选择此方法而不是其他方法。

一个带有私钥的JWT也可以用于客户端个人资料网页，以进一步加强安全。

如果您需要其他流量及其优点和缺点， 将有一个模块，可以在ZITADEL中列出更多的方法和我们建议的每个客户端的回退策略。

## Summary (3)

* 联邦身份解决传统服务器-客户端架构的关键问题和挑战
* 对用户代理人、Nantil和Web 客户使用“授权码带有验证码交换(PKCE)”
* 对于机器到机器客户端的“JWT 持有者标记”
* 如果在技术上不可能，则ZITADEL支持其他流动和后退战略

### 从这里出发的位置

* 应用程序
* 服务账户
* 替代身份验证流(aka。"The Zoo")
